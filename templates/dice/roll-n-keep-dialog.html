<form class="{{cssClass}} gfl5r roll-keep" autocomplete="off">
  <header class="d-flex align-items-center gap-3 mb-2">
    <img class="profile-img rounded" src="{{#if gfl5r.actor.img}}{{gfl5r.actor.img}}{{else}}icons/svg/mystery-man.svg{{/if}}" alt="{{#if gfl5r.actor.name}}{{gfl5r.actor.name}}{{else}}mystery{{/if}}" />
    <div class="flex-grow-1">
      <div class="fw-semibold">{{gfl5r.actor.name}}</div>
      <div class="text-muted small">
        {{#if gfl5r.stance}}{{stanceLabel gfl5r.stance}}{{/if}}
        {{#if gfl5r.skillId}}{{#if gfl5r.stance}} · {{/if}}{{skillLabel gfl5r.skillId}}{{/if}}
        {{#if gfl5r.skillCatId}} · {{skillCategoryLabel gfl5r.skillCatId}}{{/if}}
      </div>
    </div>
    <div class="text-end small">
      <div>
        TN
        {{#if gfl5r.difficultyHidden}}
          {{gfl5r.difficulty}}{{#if gfl5r.difficulty}} {{/if}}<i class="fas fa-eye-slash" title="Hidden TN"></i>
        {{else}}
          {{#if gfl5r.difficulty}}{{gfl5r.difficulty}}{{else}}?{{/if}}
        {{/if}}
      </div>
      {{#if gfl5r.voidPointUsed}}<div class="text-warning">Fortune spent</div>{{/if}}
    </div>
  </header>

  {{#unless showStrifeBt}}
    <section class="card p-2 mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <div class="dropbox swap border rounded p-2 h-100" data-type="swap">
            <div class="section-header fw-semibold mb-2"><i class="fa fa-arrows-alt-h"></i> Swap Ring</div>
            <div class="d-flex flex-wrap gap-2">
              {{#each data.swapDiceFaces.rings}}
                <div class="dice dropbox faces-change border rounded p-1" data-type="swap" data-face="{{this}}" data-die="RingDie">
                  <img src="{{getDiceFaceUrl 'RingDie' this}}" alt="{{this}}" />
                </div>
              {{/each}}
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="d-flex flex-column gap-2 h-100">
            <div class="dropbox discards border rounded p-2" data-type="discard">
              <div class="section-header fw-semibold mb-2"><i class="fa fa-times"></i> Discard</div>
            </div>
            <div class="dropbox rerolls border rounded p-2" data-type="reroll">
              <div class="section-header fw-semibold mb-2"><i class="fa fa-redo-alt"></i> Reroll</div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm text-center align-middle mb-2">
                <tbody>
                {{#each data.dicesList as |item idxStep|}}
                  <tr>
                    {{#each item as |dice idxDie|}}
                      <td>
                        {{#if dice.face}}
                          {{#if dice.newFace}}
                            <span class="dice-ct {{dice.choice}}">
                              <img class="dice {{dice.choice}}{{#ifCond ../../data.currentStep '==' idxStep}} draggable{{/ifCond}}" data-step="{{idxStep}}" data-die="{{idxDie}}" src="{{getDiceFaceUrl dice.type dice.newFace}}" alt="{{idxStep}}_{{idxDie}}" />
                            </span>
                          {{else}}
                            <span class="dice-ct {{dice.choice}}">
                              <img class="dice {{dice.choice}}{{#ifCond ../../data.currentStep '==' idxStep}} draggable{{/ifCond}}" data-step="{{idxStep}}" data-die="{{idxDie}}" src="{{getDiceFaceUrl dice.type dice.face}}" alt="{{idxStep}}_{{idxDie}}" />
                            </span>
                          {{/if}}
                        {{/if}}
                      </td>
                    {{/each}}
                  </tr>
                {{/each}}
                </tbody>
              </table>
            </div>
            <div class="dropbox keeps border rounded p-2" data-type="keep">
              <div class="section-header fw-semibold mb-2"><i class="fa fa-check"></i> Keep (max {{gfl5r.keepLimit}})</div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="dropbox swap border rounded p-2 h-100" data-type="swap">
            <div class="section-header fw-semibold mb-2"><i class="fa fa-arrows-alt-h"></i> Swap Skill</div>
            <div class="d-flex flex-wrap gap-2">
              {{#each data.swapDiceFaces.skills}}
                <div class="dice dropbox faces-change border rounded p-1" data-type="swap" data-face="{{this}}" data-die="AbilityDie">
                  <img src="{{getDiceFaceUrl 'AbilityDie' this}}" alt="{{this}}" />
                </div>
              {{/each}}
            </div>
          </div>
        </div>
      </div>
    </section>
  {{/unless}}

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
    {{#if showStrifeBt}}
      <div class="w-100">
        <div class="fw-semibold mb-1">Apply Strife</div>
        <div class="d-flex align-items-center gap-3">
          <input id="strife-applied" class="form-range flex-grow-1" type="range" name="strifeApplied" min="0" max="{{gfl5r.summary.strife}}" value="{{gfl5r.strifeApplied}}" />
          <input class="form-control form-control-sm" type="number" name="strifeApplied" min="0" max="{{gfl5r.summary.strife}}" value="{{gfl5r.strifeApplied}}" style="width:90px;">
          <span class="text-muted small">/ {{gfl5r.summary.strife}}</span>
        </div>
      </div>
    {{else}}
      <div class="small text-muted d-flex align-items-center gap-3 legend-row">
        <span class="d-flex align-items-center gap-2">
          <img src="{{getDiceFaceUrl 'RingDie' 5}}" alt="Success" class="legend-face" /> Success
        </span>
        <span class="d-flex align-items-center gap-2">
          <img src="{{getDiceFaceUrl 'RingDie' 6}}" alt="Explosive" class="legend-face" /> Explosive
        </span>
        <span class="d-flex align-items-center gap-2">
          <img src="{{getDiceFaceUrl 'RingDie' 3}}" alt="Opportunity" class="legend-face" /> Opportunity
        </span>
        <span class="d-flex align-items-center gap-2">
          <img src="{{getDiceFaceUrl 'RingDie' 4}}" alt="Strife" class="legend-face" /> Strife
        </span>
      </div>
    {{/if}}
    <div class="d-flex gap-2">
      <button id="undo-step" type="button" class="btn btn-outline-secondary btn-sm">Undo</button>
      <button id="finalize" name="finalize" type="submit" class="btn btn-primary btn-sm" {{#if data.submitDisabled}}disabled{{/if}}>
        {{#if showStrifeBt}}Apply{{else}}Finalize{{/if}}
      </button>
    </div>
  </div>
</form>
