<form class="actor-sheet gfl5r-sheet container-fluid py-3 text-light" data-bs-theme="dark" autocomplete="off">

  <header class="mb-4">
    <div class="row g-3 align-items-start">
      <div class="col-auto">
        <img class="img-thumbnail avatar-96" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" alt="{{actor.name}} portrait"/>
      </div>
      <div class="col">
        <div class="d-flex flex-column gap-3">
            <div>
              <label class="visually-hidden" for="actor-name">Character Name</label>
              <input id="actor-name" class="form-control form-control-lg fw-bold" name="name" type="text" value="{{actor.name}}" placeholder="Character Name" aria-label="Character name"/>
              {{#if originDisplay}}
                <div class="small text-muted mt-1">{{originDisplay}}</div>
              {{/if}}
            </div>
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label pill-muted mb-1" for="char-type">Type</label>
                <select id="char-type" class="form-select" name="system.characterType" title="Character type affects available features">
                  {{selectOptions (object "human" "Human" "transhumanist" "Transhumanist" "doll" "Doll") selected=actor.system.characterType localize=false}}
                </select>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label pill-muted mb-1" for="humanity">Humanity</label>
                <input id="humanity" class="form-control" type="number" name="system.humanity" value="{{actor.system.humanity}}" min="0" aria-label="Humanity"/>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label pill-muted mb-1" for="fame">Fame</label>
                <input id="fame" class="form-control" type="number" name="system.fame" value="{{actor.system.fame}}" min="0" aria-label="Fame"/>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label pill-muted mb-1 d-block" for="xp">Experience</label>
          <input id="xp" class="form-control form-control-lg text-end" type="number" name="system.xp" value="{{actor.system.xp}}" min="0" aria-label="Experience points" />
        <div class="small text-muted mt-1">Saved XP</div>
        <div class="mt-2 d-flex justify-content-md-end">
          <button type="button" class="btn btn-outline-light btn-sm" data-action="open-character-builder" title="Guided character creation">
            <i class="fas fa-magic me-1"></i> Character Creation
          </button>
        </div>
      </div>
    </div>
  </header>

  <section class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header fw-semibold">Approaches</div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3">
            {{#each approachesList as |approach|}}
              <div class="card skill-card flex-grow-1 min-w-220" data-approach-card data-approach-key="{{approach.key}}">
                <div class="card-body">
                  <div class="d-flex flex-column">
                    <div class="fw-semibold">{{approach.label}}</div>
                  </div>
                  <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-light btn-sm" data-action="approach-decrease" data-approach="{{approach.key}}" title="Refund last rank">-</button>
                    <span class="skill-rank-display">{{approach.value}}</span>
                    <button type="button" class="btn btn-primary btn-sm" data-action="approach-increase" data-approach="{{approach.key}}" title="Buy next rank">+</button>
                  </div>
                </div>
              </div>
            {{/each}}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header fw-semibold text-end">State</div>
        <div class="card-body">
          <div class="d-flex flex-column gap-2 align-items-end">
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0" for="fatigue">Fatigue</label>
              <input id="fatigue" class="form-control form-control-sm text-end w-80" type="number" name="system.resources.fatigue" value="{{actor.system.resources.fatigue}}" min="0" aria-label="Fatigue"/>
              <span>/</span>
              <label class="form-label mb-0" for="endurance">Endurance</label>
              <input id="endurance" class="form-control form-control-sm text-end w-80" type="text" value="{{derived.endurance}}" disabled aria-label="Endurance"/>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0" for="strife">Strife</label>
              <input id="strife" class="form-control form-control-sm text-end w-80" type="number" name="system.resources.strife" value="{{actor.system.resources.strife}}" min="0" aria-label="Strife"/>
              <span>/</span>
              <label class="form-label mb-0" for="composure">Composure</label>
              <input id="composure" class="form-control form-control-sm text-end w-80" type="text" value="{{derived.composure}}" disabled aria-label="Composure"/>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0" for="vigilance">Vigilance</label>
              <input id="vigilance" class="form-control form-control-sm text-end w-90" type="text" value="{{derived.vigilance}}" disabled aria-label="Vigilance"/>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0" for="focus">Focus</label>
              <input id="focus" class="form-control form-control-sm text-end w-90" type="text" value="{{derived.focus}}" disabled aria-label="Focus"/>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="form-label mb-0" for="fortune-current">Fortune Points</label>
              <input id="fortune-current" class="form-control form-control-sm text-end w-80" type="number" name="system.resources.fortunePoints" value="{{actor.system.resources.fortunePoints}}" min="0" aria-label="Fortune points current"/>
              <span>/</span>
              <input id="fortune-max" class="form-control form-control-sm text-end w-80" type="text" value="{{derived.fortunePointsMax}}" disabled aria-label="Fortune points maximum"/>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <ul class="nav nav-tabs tabs" data-group="primary">
    <li class="nav-item"><a class="nav-link active item" data-tab="skills">Skills</a></li>
    <li class="nav-item"><a class="nav-link item" data-tab="disciplines">Disciplines</a></li>
    {{#if showModules}}
      <li class="nav-item"><a class="nav-link item" data-tab="modules">Modules</a></li>
    {{/if}}
    <li class="nav-item"><a class="nav-link item" data-tab="status">Status</a></li>
    <li class="nav-item"><a class="nav-link item" data-tab="combat">Combat</a></li>
    <li class="nav-item"><a class="nav-link item" data-tab="inventory">Inventory</a></li>
    <li class="nav-item"><a class="nav-link item" data-tab="narrative">Narrative</a></li>
  </ul>

  <section class="tab-content sheet-body mt-0">
    <section class="tab-pane active tab p-3" data-group="primary" data-tab="skills">
      <div class="row g-4">
        <div class="col-lg-8">
          {{#each skillGroups as |group|}}
            <div class="card mb-3">
              <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
                <span>{{group.title}}</span>
                <span class="small text-muted">Click skill name to roll</span>
              </div>
              <div class="card-body">
                <div class="d-flex flex-wrap gap-3">
                  {{#each group.items as |skill|}}
                    <div class="card skill-card skill-roll flex-grow-1 min-w-240" data-skill-card data-skill-key="{{skill.key}}">
                      <div class="card-body">
                          <div class="d-flex flex-column">
                            <button type="button" class="btn-skill-roll" data-action="roll-skill" data-skill="{{skill.key}}">
                              {{skill.label}}
                            </button>
                            {{#if skill.itemId}}<input type="hidden" data-item-id="{{skill.itemId}}" />{{/if}}
                          </div>
                        <div class="d-flex align-items-center gap-2">
                          <button type="button" class="btn btn-outline-light btn-sm" data-action="skill-decrease" data-skill="{{skill.key}}" title="Refund last rank">-</button>
                          <span class="skill-rank-display">{{lookup ../../skills skill.key}}</span>
                          <button type="button" class="btn btn-primary btn-sm" data-action="skill-increase" data-skill="{{skill.key}}" title="Buy next rank">+</button>
                        </div>
                      </div>
                    </div>
                  {{/each}}
                </div>
              </div>
            </div>
          {{/each}}
        </div>
        <aside class="col-lg-4">
          <div class="card h-100">
            <div class="card-header fw-semibold">Discipline Abilities</div>
            <div class="card-body">
              {{#each disciplineSlots as |slot|}}
                {{#if slot.discipline}}
                  <div class="mb-3">
                    <h3 class="h6 mb-2">{{slot.discipline.name}} (Slot {{slot.slotNumber}})</h3>
                    {{#if slot.abilities.length}}
                      <div class="list-group list-group-flush">
                        {{#each slot.abilities as |ability|}}
                          <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{ability.id}}">
                            <img src="{{ability.img}}" alt="" class="rounded icon-32" />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ability.name}}</div>
                              <div class="small text-muted">
                                {{#if ability.system.activation}}{{ability.system.activation}}{{/if}}
                                {{#if ability.system.xpCost}} • XP: {{ability.system.xpCost}}{{/if}}
                              </div>
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-action="edit-item" data-item-id="{{ability.id}}" title="Edit ability">
                              <i class="fas fa-edit"></i>
                            </button>
                          </div>
                        {{/each}}
                      </div>
                    {{else}}
                      <div class="text-muted small">No abilities yet</div>
                    {{/if}}
                  </div>
                {{/if}}
              {{/each}}
            </div>
          </div>
        </aside>
      </div>
    </section>

    <section class="tab-pane tab p-3" data-group="primary" data-tab="disciplines">
      <div class="card">
        <div class="card-header fw-semibold">Disciplines</div>
        <div class="card-body">
          {{#unless (some disciplineSlots "discipline")}}
            <div class="drop-zone p-3 text-center" data-drop-target="discipline" data-slot-key="slot1" title="Drag & drop a discipline item here">
              <div class="fw-semibold">Drop your first discipline here to get started</div>
            </div>
          {{/unless}}

          {{#each disciplineSlots as |slot|}}
            {{#if slot.discipline}}
              <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">{{slot.discipline.name}}</div>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" data-action="edit-item" data-item-id="{{slot.discipline.id}}" title="Edit discipline"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn btn-outline-danger" data-action="remove-discipline" data-slot-key="{{slot.slotKey}}" title="Remove discipline"><i class="fas fa-times"></i></button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="row g-3 align-items-start mb-3">
                    <div class="col-auto">
                      <img src="{{slot.discipline.img}}" alt="" class="img-thumbnail icon-64"/>
                    </div>
                    <div class="col">
                      {{#if slot.discipline.system.category}}
                        <div class="small text-muted mb-2">Category: {{slot.discipline.system.category}}</div>
                      {{/if}}
                      <div class="row g-3 max-w-360">
                        <div class="col-sm-6">
                          <label class="form-label" for="slot-{{slot.slotKey}}-xp">XP</label>
                          <input id="slot-{{slot.slotKey}}-xp" class="form-control" type="number" value="{{slot.xp}}" disabled aria-label="Discipline XP"/>
                        </div>
                        <div class="col-sm-6">
                          <label class="form-label" for="slot-{{slot.slotKey}}-rank">Rank</label>
                          <input id="slot-{{slot.slotKey}}-rank" class="form-control" type="number" value="{{slot.rank}}" disabled aria-label="Discipline rank"/>
                        </div>
                      </div>
                      {{#if slot.associatedSkillText}}
                        <div class="small text-muted mt-2">Associated Skills: {{slot.associatedSkillText}}</div>
                      {{/if}}
                      {{#if slot.xpRemaining}}
                        <div class="small text-muted mt-2">{{slot.xpRemaining}} XP until Rank {{add slot.rank 1}}</div>
                      {{/if}}
                    </div>
                  </div>

                  {{#if slot.discipline.system.description}}
                    <div class="card mb-3">
                      <div class="card-body">{{{slot.discipline.system.description}}}</div>
                    </div>
                  {{/if}}

                  <div class="mb-2">
                    <h4 class="h6">Abilities</h4>
                    <div class="drop-zone p-3 mb-2" data-drop-target="discipline-ability" data-slot-key="{{slot.slotKey}}" title="Drag & drop ability items here">
                      <div class="fw-semibold">Drop abilities for this discipline here (costs 3 XP)</div>
                    </div>
                    {{#if slot.abilities.length}}
                      <div class="list-group list-group-flush">
                        {{#each slot.abilities as |ability|}}
                          <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{ability.id}}">
                            <img src="{{ability.img}}" alt="" class="rounded icon-32" />
                            <div class="flex-grow-1">
                              <div class="fw-semibold">{{ability.name}}</div>
                              <div class="small text-muted">
                                {{#if ability.system.activation}}{{ability.system.activation}}{{/if}}
                                {{#if ability.system.xpCost}} • XP: {{ability.system.xpCost}}{{/if}}
                                {{#if ability.system.requiredRank}} • Req. Rank: {{ability.system.requiredRank}}{{/if}}
                              </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                              <button type="button" class="btn btn-outline-secondary" data-action="edit-item" data-item-id="{{ability.id}}" title="Edit ability"><i class="fas fa-edit"></i></button>
                              <button type="button" class="btn btn-outline-danger" data-action="remove-discipline-ability" data-slot-key="{{../slot.slotKey}}" data-ability-id="{{ability.id}}" title="Remove ability"><i class="fas fa-trash"></i></button>
                            </div>
                          </div>
                        {{/each}}
                      </div>
                    {{else}}
                      <div class="text-muted small">No abilities assigned yet.</div>
                    {{/if}}
                  </div>
                </div>
              </div>
            {{/if}}
          {{/each}}

          {{#if (lt (count disciplineSlots "discipline") 5)}}
            <div class="drop-zone p-3 text-center" data-drop-target="discipline" data-slot-key="{{getNextEmptySlot disciplineSlots}}" title="Drag & drop another discipline item here">
              <div class="fw-semibold"><i class="fas fa-plus-circle"></i> Drop another discipline here ({{count disciplineSlots "discipline"}}/5)</div>
            </div>
          {{/if}}
        </div>
      </div>
    </section>

    {{#if showModules}}
    <section class="tab-pane tab p-3" data-group="primary" data-tab="modules">
      <div class="card">
        <div class="card-header fw-semibold">Body Modules</div>
        <div class="card-body">
          <p class="text-muted mb-3">
            {{#if (eq characterType "doll")}}
              As a Doll, you can install body modification modules to enhance your capabilities.
            {{else}}
              As a Transhumanist, you have embraced body modification technology.
            {{/if}}
          </p>
          <div class="drop-zone p-3 text-center" data-drop-target="modules" title="Drag & drop module items here">
            <div class="fw-semibold">Drop modules here</div>
          </div>
          <div class="mt-3">
            {{#if modules.length}}
              <div class="list-group list-group-flush">
                {{#each modules as |module|}}
                  <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{module.id}}">
                    <img src="{{module.img}}" alt="" class="rounded icon-32" />
                    <div class="flex-grow-1">
                      <div class="fw-semibold">{{module.name}}</div>
                      <div class="small text-muted">
                        {{#if module.system.points}}Points: {{module.system.points}}{{/if}}
                        {{#if module.system.sardisGold}} • Sardis Gold: {{module.system.sardisGold}}¤{{/if}}
                      </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-secondary" data-action="edit-item" data-item-id="{{module.id}}" title="Edit module"><i class="fas fa-edit"></i></button>
                      <button type="button" class="btn btn-outline-danger" data-action="delete-item" data-item-id="{{module.id}}" title="Remove module"><i class="fas fa-trash"></i></button>
                    </div>
                  </div>
                {{/each}}
              </div>
            {{else}}
              <div class="text-muted">No modules installed.</div>
            {{/if}}
          </div>
        </div>
      </div>
    </section>
    {{/if}}

    <section class="tab-pane tab p-3" data-group="primary" data-tab="status">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header fw-semibold">Collapse</div>
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="pill-muted" id="collapse-exposure-label">Exposure</div>
                <div class="fw-semibold">{{collapse.current}} / {{collapse.capacity}}</div>
              </div>
              <div class="collapse-progress mb-2">
                <progress class="collapse-bar" aria-labelledby="collapse-exposure-label" value="{{collapse.current}}" max="{{collapse.capacity}}" aria-valuetext="{{collapse.current}} of {{collapse.capacity}}"></progress>
              </div>
              <div class="small text-muted mb-3">Maximum collapse equals the sum of all approaches times 5.</div>
              <div class="d-flex align-items-center gap-2">
                <label class="form-label mb-0" for="collapse-current">Current Collapse</label>
                <input id="collapse-current" class="form-control form-control-sm text-end w-110" type="number" name="system.resources.collapse" value="{{actor.system.resources.collapse}}" min="0" aria-label="Current collapse" />
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
              <span>Conditions</span>
              <span class="small text-muted">Drop condition items to track effects</span>
            </div>
            <div class="card-body">
              <div class="drop-zone p-3 text-center mb-3" data-drop-target="condition" title="Drag & drop condition items here">
                <div class="fw-semibold">Drop conditions here</div>
              </div>
              {{#if conditions.length}}
                <div class="list-group list-group-flush">
                  {{#each conditions as |condition|}}
                    <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{condition.id}}">
                      <img src="{{condition.img}}" alt="" class="rounded icon-32" />
                      <div class="flex-grow-1">
                        <div class="fw-semibold">{{condition.name}}</div>
                        <div class="small text-muted">
                          {{#if condition.system.duration}}<span class="status-chip">Duration: {{condition.system.duration}}</span>{{/if}}
                          {{#if condition.system.tags}}<span class="status-chip ms-1">Tags: {{condition.system.tags}}</span>{{/if}}
                        </div>
                      </div>
                      <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" data-action="edit-item" data-item-id="{{condition.id}}" title="Edit condition"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn btn-outline-danger" data-action="delete-item" data-item-id="{{condition.id}}" title="Remove condition"><i class="fas fa-trash"></i></button>
                      </div>
                    </div>
                  {{/each}}
                </div>
              {{else}}
                <div class="text-muted">No active conditions.</div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab-pane tab p-3" data-group="primary" data-tab="combat">
      <div class="card mb-3">
        <div class="card-header fw-semibold">Combat Posture</div>
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-md-8">
              <div class="form-label pill-muted" id="posture-label">Posture</div>
              <div class="d-flex flex-wrap gap-3 align-items-center" role="radiogroup" aria-labelledby="posture-label">
                {{#each (object
                  "power" "Power"
                  "swiftness" "Swiftness"
                  "resilience" "Resilience"
                  "precision" "Precision"
                  "fortune" "Fortune") as |label key|}}
                  <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="radio" name="system.posture" id="posture-{{key}}" value="{{key}}" {{#ifCond ../actor.system.posture "==" key}}checked{{/ifCond}}>
                    <label class="form-check-label" for="posture-{{key}}">{{label}}</label>
                  </div>
                {{/each}}
              </div>
              {{#with (object
                "power" "Additional success per strife kept on successful checks"
                "swiftness" "Take an additional action that doesn't require a check"
                "resilience" "Enemies cannot spend opportunity for critical strikes/conditions"
                "precision" "Increase TN of attacks/schemes against you by 1 (2 if fortification 4+)"
                "fortune" "No strife from strife symbols on kept dice") as |postureText|}}
                <div class="mt-2 text-muted">{{lookup postureText ../actor.system.posture}}</div>
              {{/with}}
            </div>
            <div class="col-md-4">
              <div class="form-check form-switch d-flex align-items-center gap-2 justify-content-end m-0">
                <input class="form-check-input" type="checkbox" name="system.prepared" id="prepared-toggle" {{checked preparedState}} />
                <label class="form-check-label mb-0" for="prepared-toggle">Prepared for Combat</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header fw-semibold">Weapons</div>
            <div class="card-body">
              {{#if weapons.length}}
                <div class="list-group list-group-flush">
                  {{#each weapons as |weapon|}}
                    <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{weapon.id}}">
                      <img src="{{weapon.img}}" alt="" class="rounded icon-32" />
                      <div class="flex-grow-1">
                        <div class="fw-semibold">{{weapon.name}}</div>
                        <div class="small text-muted">Range: {{weapon.system.idealRange}} | Threat: {{weapon.system.threat}}</div>
                      </div>
                      <button type="button" class="btn btn-outline-secondary btn-sm" data-action="edit-item" data-item-id="{{weapon.id}}" title="Edit item"><i class="fas fa-edit"></i></button>
                    </div>
                  {{/each}}
                </div>
              {{else}}
                <div class="text-muted">No weapons.</div>
              {{/if}}
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header fw-semibold">Armor</div>
            <div class="card-body">
              {{#if armor.length}}
                <div class="list-group list-group-flush">
                  {{#each armor as |armorItem|}}
                    <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{armorItem.id}}">
                      <img src="{{armorItem.img}}" alt="" class="rounded icon-32" />
                      <div class="flex-grow-1">
                        <div class="fw-semibold">{{armorItem.name}}</div>
                        <div class="small text-muted">Protection: {{armorItem.system.protection}} | Weight: {{armorItem.system.weight}}</div>
                      </div>
                      <button type="button" class="btn btn-outline-secondary btn-sm" data-action="edit-item" data-item-id="{{armorItem.id}}" title="Edit item"><i class="fas fa-edit"></i></button>
                    </div>
                  {{/each}}
                </div>
              {{else}}
                <div class="text-muted">No armor.</div>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="tab-pane tab p-3" data-group="primary" data-tab="inventory">
      <div class="card">
        <div class="card-header fw-semibold">Inventory</div>
        <div class="card-body">
          <div class="drop-zone p-3 text-center mb-3" data-drop-target="inventory" title="Drag & drop items here">
            <div class="fw-semibold">Drop items here</div>
          </div>
          {{#if inventory.length}}
            <table class="table table-sm align-middle text-light">
              <thead class="table-dark">
                <tr>
                  <th>Item</th>
                  <th>Type</th>
                  <th class="text-center">Qty</th>
                  <th class="text-end">Price</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {{#each inventory as |item|}}
                  <tr data-item-id="{{item.id}}">
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <img src="{{item.img}}" alt="" class="rounded icon-32"/>
                        <strong>{{item.name}}</strong>
                      </div>
                    </td>
                    <td class="text-capitalize">{{item.type}}</td>
                    <td class="text-center w-90">
                      <input class="form-control form-control-sm text-center" type="number" name="items.{{item.id}}.system.quantity" value="{{item.system.quantity}}" min="0" aria-label="Quantity for {{item.name}}" />
                    </td>
                    <td class="text-end">{{#if item.system.price}}{{item.system.price}}¤{{else}}—{{/if}}</td>
                    <td class="text-center w-110">
                      <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" data-action="edit-item" data-item-id="{{item.id}}" title="Edit item"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn btn-outline-danger" data-action="delete-item" data-item-id="{{item.id}}" title="Delete item"><i class="fas fa-trash"></i></button>
                      </div>
                    </td>
                  </tr>
                {{/each}}
              </tbody>
            </table>
          {{else}}
            <div class="text-muted">No items in inventory.</div>
          {{/if}}
        </div>
      </div>
    </section>

    <section class="tab-pane tab p-3" data-group="primary" data-tab="narrative">
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card mb-3">
            <div class="card-header fw-semibold">Distinctions and Passions</div>
            <div class="card-body">
              <div class="drop-zone p-3 text-center mb-2" data-drop-target="narrative-positive" title="Drag & drop Distinction or Passion items here">
                <div class="fw-semibold">Drop Distinction/Passion items here</div>
              </div>
              {{#if narrativePositive.length}}
                <div class="list-group list-group-flush">
                  {{#each narrativePositive as |item|}}
                    <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" alt="" class="rounded icon-32" />
                      <div class="flex-grow-1">
                        <div class="fw-semibold">{{item.name}}</div>
                        <div class="small text-muted">{{item.system.approach}} - {{item.system.narrativeType}}</div>
                      </div>
                      <button type="button" class="btn btn-outline-danger btn-sm" data-action="delete-item" data-item-id="{{item.id}}" title="Remove item"><i class="fas fa-trash"></i></button>
                    </div>
                  {{/each}}
                </div>
              {{else}}
                <div class="text-muted">No distinctions or passions yet.</div>
              {{/if}}
            </div>
          </div>

          <div class="card">
            <div class="card-header fw-semibold">Adversities and Anxieties</div>
            <div class="card-body">
              <div class="drop-zone p-3 text-center mb-2" data-drop-target="narrative-negative" title="Drag & drop Adversity or Anxiety items here">
                <div class="fw-semibold">Drop Adversity/Anxiety items here</div>
              </div>
              {{#if narrativeNegative.length}}
                <div class="list-group list-group-flush">
                  {{#each narrativeNegative as |item|}}
                    <div class="list-group-item d-flex align-items-center gap-2" data-item-id="{{item.id}}">
                        <img src="{{item.img}}" alt="" class="rounded icon-32" />
                      <div class="flex-grow-1">
                        <div class="fw-semibold">{{item.name}}</div>
                        <div class="small text-muted">{{item.system.approach}} - {{item.system.narrativeType}}</div>
                      </div>
                      <button type="button" class="btn btn-outline-danger btn-sm" data-action="delete-item" data-item-id="{{item.id}}" title="Remove item"><i class="fas fa-trash"></i></button>
                    </div>
                  {{/each}}
                </div>
              {{else}}
                <div class="text-muted">No adversities or anxieties yet.</div>
              {{/if}}
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card mb-3">
            <div class="card-header fw-semibold">Backstory</div>
            <div class="card-body">
              <label class="visually-hidden" for="backstory">Backstory</label>
              <textarea id="backstory" class="form-control" name="system.backstory" rows="10">{{actor.system.backstory}}</textarea>
            </div>
          </div>
          <div class="card">
            <div class="card-header fw-semibold">Notes</div>
            <div class="card-body">
              <label class="visually-hidden" for="notes">Notes</label>
              <textarea id="notes" class="form-control" name="system.notes" rows="10">{{actor.system.notes}}</textarea>
            </div>
          </div>
        </div>
      </div>
    </section>
  </section>
</form>
