# Copilot Instructions for GFL5R-Foundry
- System scope: Foundry VTT game system (id "gfl5r") for a near-future L5R variant; ES modules loaded directly from the manifest in [system.json](system.json). No build tooling, bundlers, or package.json—edit JS/HTML/CSS in place and reload the world in Foundry.
- Entry point: [module/main.js](module/main.js) runs on `init`, registers Handlebars helpers, world settings, swaps in the custom combat class, and registers all actor/item sheets and dice terms. New global setup belongs here.
- Configuration: [module/config.js](module/config.js) holds discipline XP tables, max discipline slots (5), and initiative skill mapping; helper methods compute cumulative XP and rank from XP. Reuse these helpers instead of duplicating math.
- Settings: [module/settings.js](module/settings.js) defines world-scoped settings for initiative (encounter type, difficulty, hidden flag, prepared flag). Changing the encounter setting forces the combat tracker to rerender. Follow the same pattern for new system settings.
- Handlebars helpers: Registered centrally in [module/utils/handlebars.js](module/utils/handlebars.js) (object builder, eq/ifCond, discipline slot helpers, etc.). Add template helpers here so they are available across sheets.
- Actor sheets: [module/actors.js](module/actors.js) implements character and NPC sheets. Character sheets compute derived stats with [module/utils/derived.js](module/utils/derived.js), manage up to five discipline slots, and orchestrate item drops for abilities, disciplines, modules, narrative items, and inventory. NPC sheets are simpler, treating all items as features. Extend these classes instead of modifying core Foundry behavior.
- Item sheets: [module/items.js](module/items.js) registers separate sheets for abilities, weaponry, armor, narrative items, generic items, disciplines, and modules. Register new item types here and add matching templates under templates/.
- Dice roller: [module/dice.js](module/dice.js) provides `GFLRollerApp` with interactive keep/reroll/explosion flow, updates a chat message after every action, and applies hidden-TN fortune bonuses and initiative integration. Use `registerDiceTerms` (currently empty) if adding custom dice terms.
- Combat: [module/combat.js](module/combat.js) overrides `rollInitiative` to prompt per-combatant rolls using the roller app and base initiative logic (prepared vs. unprepared). Sorting favors higher initiative then name. Keep new combat logic consistent with this override.
- Hooks/UI: [module/hooks.js](module/hooks.js) injects a GM-only combat tracker bar (encounter type + prepared toggle) on `renderCombatTracker`, rendering [templates/gm/combat-tracker-bar.html](templates/gm/combat-tracker-bar.html) and persisting selections to world settings. Add UI hooks here to keep side effects centralized.
- Templates/assets: Sheet and roller UIs live in templates/ (actor/item sheets, roller, roll prompt, GM tracker). Dice face icons are in assets/dice/black and assets/dice/white; paths are built dynamically in the roller.
- Data conventions: System data uses `actor.system` fields `approaches`, `resources`, `skills`, `disciplines` (slot1..slot5 with disciplineId/xp/rank/abilities), and item types include ability/weaponry/armor/narrative/item/discipline/module. Preserve these keys when updating schema or handling drops.
- Derivatives and limits: Derived stats (endurance, composure, vigilance, focus, fortune points) depend on approaches/resources; keep logic in [module/utils/derived.js](module/utils/derived.js) in sync with sheet displays. Keep-limit in the roller equals the chosen approach value, with explosion dice not counting toward the limit.
- Compatibility: Targeted for Foundry v12+ (verified v13) per [system.json](system.json); some code (Hooks, Item.implementation) includes v12 compatibility shims—avoid removing unless dropping v12 support.
- Debugging: Console logging is enabled throughout modules for quick tracing. To test changes, reload the Foundry world; there are no automated tests.
- When adding features: register new settings and helpers up front, prefer dialogs/templates for user input, wire UI actions with jQuery-style `html.on` handlers, and keep chat updates and notifications consistent with existing roller/combat patterns.
- Versioning rule: whenever making any change, increment the patch component of the semver in [system.json](system.json) (line 5) by 1.
